<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Weekly Predictions</title>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 900px; }
        .table-container { max-height: 200px; overflow-y: auto; }
        .prediction-card { padding: 15px; background: #fff; border-radius: 8px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1); }
        #uploadSection { margin-bottom: 20px; padding: 15px; background: #e9ecef; border-radius: 8px; }
        #loadingSpinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; }
        .nav-link { margin-top: 20px; }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center">ðŸ“Š Weekly Predictions</h1>
    <div id="uploadSection">
        <h4>Upload New CSV Data to Update Weekly Model</h4>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <input type="file" id="csvFile" accept=".csv" class="form-control-file" required>
            </div>
            <button type="submit" class="btn btn-info">Upload and Update Weekly Model</button>
        </form>
    </div>
    <div class="btn-group d-flex justify-content-center mb-3">
        <button type="button" class="btn btn-primary" onclick="getPrediction('week_1')">Week 1</button>
        <button type="button" class="btn btn-primary" onclick="getPrediction('week_2')">Week 2</button>
        <button type="button" class="btn btn-primary" onclick="getPrediction('week_3')">Week 3</button>
        <button type="button" class="btn btn-primary" onclick="getPrediction('week_4')">Week 4</button>
    </div>
    <div class="btn-group d-flex justify-content-center mb-3">
        <button class="btn btn-success" onclick="downloadCSV(1)">Download Week 1</button>
        <button class="btn btn-success" onclick="downloadCSV(2)">Download Week 2</button>
        <button class="btn btn-success" onclick="downloadCSV(3)">Download Week 3</button>
        <button class="btn btn-success" onclick="downloadCSV(4)">Download Week 4</button>
    </div>
    <div class="d-flex justify-content-center mb-3">
        <button class="btn btn-warning" onclick="analyzeData()">ðŸ“Š Analyze Data</button>
        <button class="btn btn-danger ml-2" onclick="downloadAll()">ðŸ“‚ Download All</button>
    </div>
    <div id="predictionContainer" class="prediction-card">
        <h3 id="predictionTitle"></h3>
        <div class="table-container">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Time Step</th>
                        <th>Electricity Power (kW)</th>
                    </tr>
                </thead>
                <tbody id="predictionOutput"></tbody>
            </table>
        </div>
    </div>
    <div class="mt-3">
        <h3>ðŸ“Š Analysis Report</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Mean</th>
                    <th>Min</th>
                    <th>Max</th>
                </tr>
            </thead>
            <tbody id="analysisOutput"></tbody>
        </table>
    </div>
    <div class="mt-3">
        <h3>ðŸ“ˆ Trend Analysis (Increase/Decrease from Previous Week)</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Week</th>
                    <th>Mean Change</th>
                    <th>Min Change</th>
                    <th>Max Change</th>
                </tr>
            </thead>
            <tbody id="trendOutput"></tbody>
        </table>
    </div>
    <canvas id="predictionChart" width="800" height="400"></canvas>
    <div class="text-center nav-link">
        <a href="/" class="btn btn-link">Back to Main Page</a>
    </div>
</div>
<div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
    <p class="text-center">Updating model, please wait...</p>
</div>
<script>
    let chart;
    let currentPredictions = null;
    async function getPrediction(week) {
        let predictions;
        if (currentPredictions) {
            predictions = currentPredictions;
        } else {
            try {
                const response = await fetch('/predict');
                predictions = await response.json();
            } catch (error) {
                console.error('Error fetching predictions:', error);
                return;
            }
        }
        const preds = predictions[week];
        document.getElementById('predictionTitle').innerText = week.replace('_', ' ') + " Predictions";
        let tableRows = preds.map((value, index) => `<tr><td>${index+1}</td><td>${value.toFixed(2)}</td></tr>`).join('');
        document.getElementById('predictionOutput').innerHTML = tableRows;
        const labels = preds.map((_, index) => index+1);
        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = preds;
            chart.update();
        } else {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Electricity Power (kW)',
                        data: preds,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time Step' } },
                        y: { title: { display: true, text: 'Electricity Power (kW)' } }
                    }
                }
            });
        }
    }
    function downloadCSV(week) {
        window.location.href = `/download/${week}`;
    }
    function downloadAll() {
        window.location.href = '/download_all';
    }
    async function analyzeData() {
        try {
            const response = await fetch('/analyze');
            const analysis = await response.json();
            let analysisTable = analysis.map(item => 
                `<tr>
                    <td>${item.Week}</td>
                    <td>${item.Mean.toFixed(2)}</td>
                    <td>${item.Min.toFixed(2)}</td>
                    <td>${item.Max.toFixed(2)}</td>
                </tr>`).join('');
            document.getElementById('analysisOutput').innerHTML = analysisTable;
            let trendTable = '';
            for (let i = 1; i < analysis.length; i++) {
                let prev = analysis[i-1];
                let current = analysis[i];
                let meanChange = (current.Mean - prev.Mean).toFixed(2);
                let minChange = (current.Min - prev.Min).toFixed(2);
                let maxChange = (current.Max - prev.Max).toFixed(2);
                trendTable += `
                    <tr>
                        <td>Week ${i+1}</td>
                        <td style="color: ${meanChange >= 0 ? 'green' : 'red'}">${meanChange} kW</td>
                        <td style="color: ${minChange >= 0 ? 'green' : 'red'}">${minChange} kW</td>
                        <td style="color: ${maxChange >= 0 ? 'green' : 'red'}">${maxChange} kW</td>
                    </tr>
                `;
            }
            document.getElementById('trendOutput').innerHTML = trendTable;
        } catch (error) {
            console.error("Error analyzing data:", error);
        }
    }
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        document.getElementById('loadingSpinner').style.display = 'block';
        const fileInput = document.getElementById('csvFile');
        if(fileInput.files.length === 0){
            alert("Please select a CSV file to upload.");
            document.getElementById('loadingSpinner').style.display = 'none';
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        try {
            const response = await fetch('/upload', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.error) {
                alert("Error: " + result.error);
            } else {
                currentPredictions = result;
                updatePredictions(result);
            }
        } catch(err) {
            console.error(err);
            alert("Error uploading file.");
        } finally {
            document.getElementById('loadingSpinner').style.display = 'none';
        }
    });
    function updatePredictions(predictions) {
        const week = 'week_1';
        const preds = predictions[week];
        document.getElementById('predictionTitle').innerText = week.replace('_', ' ') + " Predictions (Updated)";
        let tableRows = preds.map((value, index) => `<tr><td>${index+1}</td><td>${value.toFixed(2)}</td></tr>`).join('');
        document.getElementById('predictionOutput').innerHTML = tableRows;
        const labels = preds.map((_, index) => index+1);
        if (chart) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = preds;
            chart.update();
        } else {
            const ctx = document.getElementById('predictionChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Electricity Power (kW)',
                        data: preds,
                        borderColor: 'rgba(0, 123, 255, 1)',
                        backgroundColor: 'rgba(0, 123, 255, 0.2)',
                        borderWidth: 2,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time Step' } },
                        y: { title: { display: true, text: 'Electricity Power (kW)' } }
                    }
                }
            });
        }
    }
</script>
</body>
</html>
